function setLanguage(a){var b=document.createElement("script");b.src="lang/"+a+".js",document.body.appendChild(b)}function Laser(){this.color=0,this.direction=0,this.isOn=!1,this.drawAge=0}function saveOptions(){Util.log("Saving options to localStorage"),localStorage.setItem("options",JSON.stringify(options))}function checkOptions(){0==options.fullscreen?c.style.height="auto":c.style.height="100%"}function Level(a,b,c){this.hint=b,this.author=c,this.name=a}function loadSound(a){var b=new Audio("sounds/"+a+".wav");sounds[a]=b,soundNames.push(a)}function pauseSounds(){for(var a=0;a<soundNames.length;a++)sounds[soundNames[a]].pause()}function rotateTool(a,b){if(void 0!=a&&!a.isPredefined){if(b=b?b:1,0>b){for(var c=b;a.rotation+c<0;)c+=4;a.rotation+=c}else b>0&&(a.rotation=(a.rotation+b)%4);console.log("rotation is"+a.rotation)}}function placeBlock(a,b,c){b=void 0==b?a.x:b,c=void 0==c?a.y:c,a.x=b,a.y=c,a.isPlaced=!0,map[b][c].block=a}function unplaceBlock(a,b){void 0!=a&&1!=a.isPredefined&&(map[a.x][a.y].block=void 0,0!=b&&(pos=getToolPosInToolBox(a),a.x=pos[0],a.y=pos[1],a.rotation=0,a.isOn=!1,a.isPlaced=!1))}function getToolFromToolbox(a){if("number"==typeof a&&(a=toolsByType[a]),void 0!=a&&"string"==typeof a){for(i=toolsByType[a].length-1;0<=i&&1==toolsByType[a][i].isPlaced;)i--;return toolsByType[a][i].isPlaced?!1:(sounds.select.play(),tools.indexOf(toolsByType[a][i]))}return!1}function getToolPosInToolBox(a){return"object"==typeof a?(pos=[width-1,toolsByType.indexOf(a.toString())+1],pos):!1}function mouseIsInToolBox(){return Util.log("mouseIsInToolBox() is deprecated, plese use Mouse.isInToolBox()!"),Mouse.isInToolBox()}function initToolBox(){toolsByType=[];for(var a=0;a<tools.length;a++)void 0===toolsByType[tools[a].toString()]&&(toolsByType.push(tools[a].toString()),toolsByType[tools[a].toString()]=new Array,Util.log("Creating new index")),Util.log("Adding tool no "+a+" to "+tools[a].toString()+"s"),toolsByType[tools[a].toString()].push(tools[a]),pos=getToolPosInToolBox(tools[a]),tools[a].x=pos[0],tools[a].y=pos[1]}function Emitter(){this.x=0,this.y=0,this.rotation=0,this.color="red",this.isOn=!0,this.isPredefined=!0}function Receiver(){this.x=0,this.y=0,this.rotation=0,this.color=0,this.isOn=!1,this.isPredefined=!0,this.input=new Interface}function Activator(){this.x=0,this.y=0,this.isOn=!1,this.isPredefined=!0}function Mirror(){this.x=0,this.y=0,this.rotation=0,this.isOn=!1,this.isPlaced=!1,this.interfaces=[new Interface(0),new Interface(1),new Interface(2),new Interface(3)]}function PortalInput(){this.x=0,this.y=0,this.rotation=0,this.color=0,this.isOn=!1,this.isPlaced=!1,this.input=new Interface}function PortalOutput(){this.x=0,this.y=0,this.rotation=0,this.color=0,this.isOn=!1,this.isPlaced=!1,this.output=new Interface}function Interface(a){this.color=0,this.isOn=!1,"number"==typeof a?this.offset=a:this.offset=0}function Prism(){this.x=0,this.y=0,this.rotation=0,this.outputColor=0,this.inputs=[new Interface(1),new Interface(3)],this.output=[new Interface(0)],this.isPlaced=!1}function Drawing(){}function initGame(){if(c=document.getElementById("game"),checkBrowserCompatibility){for(var a=0;16>a;a++){map[a]=[];for(var b=0;12>b;b++)map[a][b]=new Cell}ctx=c.getContext("2d"),loadSprite("emitter"),loadSprite("map"),loadSprite("prism"),loadSprite("receiver"),loadSprite("inventory"),loadSprite("mirror"),loadSprite("activator"),loadSprite("mouse"),loadSprite("logo"),loadSprite("rottenPotato"),loadSprite("wonPotato"),loadSprite("portalinput"),loadSprite("portaloutput"),loadSprite("menu"),loadSound("select"),loadSound("laser"),sounds.laser.loop=!0,checkOptions(),gameState=GameState.IN_MENU;new Mouse,new Keyboard;requestAnimationFrame(tick)}else c.remove(),document.body.appendChild("<h1>Dein Browser mag keine Kartoffelchips :(</h1>")}function startTimer(){timerElapsed=0,startTime=(new Date).getTime()/1e3,timerRunning=!0}function stopTimer(){timerRunning&&(timerRunning=!1,timerElapsed=(new Date).getTime()/1e3-startTime)}function startGame(){loadLevel(1)}function showOptions(){selectedMenuItem=-1,gameState=GameState.IN_OPTIONS}function showCredits(){selectedMenuItem=-1,gameState=GameState.IN_CREDITS}function showLegend(){selectedMenuItem=-1,gameState=GameState.IN_LEGEND}function checkWin(){hasWon()&&(gameState=GameState.HAS_WON,stopTimer())}function hasWon(){if(pauseSounds(),gameState==GameState.IS_PLAYING&&-1==selectedTool){for(var a=0;a<predefinedBlocks.length;a++)if(("Activator"==predefinedBlocks[a].toString()||"Receiver"==predefinedBlocks[a].toString())&&0==predefinedBlocks[a].isOn)return!1;return!0}}function resetLevel(){loadLevel(levelID)}function backToMenu(){pauseSounds(),gameState=GameState.IN_MENU,level=null,levelID=null,predefinedBlocks.length=0,tools.length=0,blocks.length=0}function showHelpMessage(){showAlert(level.hint,level.name,[new Button("OKAY",dismissAlert)],translations.AUTHOR+": "+level.author)}function dismissAlert(){currentAlert=null}function checkBrowserCompatibility(){return"onpointerlockchange"in document||"onmozpointerlockchange"in document||"onwebkitpointerlockchange"in document?!1:window.HTMLCanvasElement?!1:!0}function lockMouse(){c.requestPointerLock=c.requestPointerLock||c.mozRequestPointerLock||c.webkitRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,c.requestPointerLock()}function loadSprite(a){var b=new Image;b.src="textures/"+a+".png",sprites[a]=b}function showAlert(a,b,c,d){currentAlert=new Alert,currentAlert.message=a,currentAlert.title=b,currentAlert.buttons=c,currentAlert.subtext=d}function tick(){if(ctx.fillStyle="white",ctx.fillRect(0,0,c.width,c.height),checkWin(),document.pointerLockElement===c||document.mozPointerLockElement===c||document.webkitPointerLockElement===c||1==options.mouseDebug)switch(gameState){case GameState.IN_MENU:Drawing.drawMenuScreen();break;case GameState.IS_PLAYING:Drawing.drawBoard(),Drawing.drawPredefinedBlocks(),disableAllElements(),Drawing.drawLaserBeam(),Drawing.drawToolbar(),Drawing.drawActionButtons(),Drawing.drawTools(),Drawing.drawToolbox(),Drawing.drawToolTipForToolBoxTool(),Drawing.drawToolTipForActionButton(),Drawing.drawMouse(),currentAlert&&Drawing.drawAlert(),updateReceivers();break;case GameState.HAS_WON:Drawing.drawWinScreen();break;case GameState.IN_OPTIONS:Drawing.drawOptions();break;case GameState.IN_CREDITS:Drawing.drawCredits();break;case GameState.IN_LEGEND:Drawing.drawLegend()}else Drawing.drawPointerLockWarning();Drawing.drawCursor(),Drawing.drawFPS(),requestAnimationFrame(tick)}function updateReceivers(){for(var a=0;a<predefinedBlocks.length;a++)"Receiver"==predefinedBlocks[a].toString()&&(predefinedBlocks[a].input.color==predefinedBlocks[a].color&&1==predefinedBlocks[a].input.isOn?predefinedBlocks[a].isOn=!0:predefinedBlocks[a].isOn=!1)}function disableAllElements(){for(var a=0;a<predefinedBlocks.length;a++)"Receiver"==predefinedBlocks[a].toString()?(predefinedBlocks[a].input.isOn=!1,predefinedBlocks[a].input.color=""):"Emitter"!=predefinedBlocks[a].toString()&&(predefinedBlocks[a].isOn=!1);for(var a=0;a<tools.length;a++)"Mirror"==tools[a].toString()?(tools[a].isOn=!1,tools[a].inputs[0].isOn=!1,tools[a].inputs[1].isOn=!1,tools[a].inputs[0].color="",tools[a].inputs[1].color=""):"Prism"==tools[a].toString()?(tools[a].inputs[0].isOn=!1,tools[a].inputs[1].isOn=!1,tools[a].inputs[0].color="",tools[a].inputs[1].color=""):"PortalInput"==tools[a].toString()?(tools[a].isOn=!1,tools[a].input.isOn=!1,tools[a].input.color=""):"PortalOutput"==tools[a].toString()&&(tools[a].isOn=!1)}function blockExistsAt(a,b,c){var d=a>=0&&b>=0&&width>a&&height>b&&map[a][b].tile!=Tiles.CLEAR;return d||(d=void 0!=map[a][b].block&&map[a][b].block!=c),d}function getStringFromColor(a){var b="";switch(a){case 0:b="#ff0000";break;case 1:b="#00ff00";break;case 2:b="#0000ff"}return b}function mixColors(a,b){var c=parseInt(a.substring(1,3),16),d=parseInt(a.substring(3,5),16),e=parseInt(a.substring(5,7),16),f=parseInt(b.substring(1,3),16),g=parseInt(b.substring(3,5),16),h=parseInt(b.substring(5,7),16),i=parseInt((c+f)/2),j=parseInt((d+g)/2),k=parseInt((e+h)/2),l=255/Math.max(i,j,k);return i*=l,j*=l,k*=l,"#"+("00"+i.toString(16)).slice(-2)+("00"+j.toString(16)).slice(-2)+("00"+k.toString(16)).slice(-2)}function loadLevel(a){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4==b.readyState&&200==b.status){var c=b.responseText.match(/[^\r\n]+/g);predefinedBlocks.length=0,tools.length=0,blocks.length=0,portalInputs.length=0;for(var d=0;16>d;d++)for(var e=0;12>e;e++)map[d][e]=new Cell;level=JSON.parse(c[0]);for(var f=1;f<c.length;f++){var g=c[f].split(" ");Util.log("The first word is "+g[0]+", we still have "+c.length+" lines and i is "+d);for(var h=!1,i=0;!h&&i<c[f].length;){if("#"==c[f].charAt(i))switch(f){case 1:switch(i){case 0:map[i][f-1].tile=Tiles.CORNER_LEFT_TOP;break;case 15:map[i][f-1].tile=Tiles.CORNER_RIGHT_TOP;break;default:map[i][f-1].tile=Tiles.BORDER_TOP}break;case 12:switch(i){case 0:map[i][f-1].tile=Tiles.CORNER_LEFT_BOTTOM;break;case 15:map[i][f-1].tile=Tiles.CORNER_RIGHT_BOTTOM;break;default:map[i][f-1].tile=Tiles.BORDER_BOTTOM}break;default:switch(i){case 0:map[i][f-1].tile=Tiles.BORDER_LEFT;break;case 15:map[i][f-1].tile=Tiles.BORDER_RIGHT;break;default:map[i][f-1].tile=Tiles.FULL}}else"#"==c[f].charAt(0)?map[i][f-1].tile=Tiles.CLEAR:h=!0;i++}switch(g[0]){case"L":var j=new Emitter;placeBlock(j,parseInt(g[1]),parseInt(g[2])),j.rotation=parseInt(g[3]),j.color=getStringFromColor(parseInt(g[4])),predefinedBlocks.push(j);break;case"X":var k=new Receiver;placeBlock(k,parseInt(g[1]),parseInt(g[2])),k.rotation=parseInt(g[3]),k.color=g[4],predefinedBlocks.push(k);break;case"A":var l=new Activator;placeBlock(l,parseInt(g[1]),parseInt(g[2])),predefinedBlocks.push(l);break;case"M":for(var m=parseInt(g[1]),n=0;m>n;n++){var o=new Mirror;tools.push(o)}break;case"PL-I":var p=new PortalInput;p.color=g[1],portalInputs[p.color]=p,tools.push(p);break;case"PL-O":for(var m=parseInt(g[1]),n=0;m>n;n++){var q=new PortalOutput;q.color=g[2],tools.push(q)}break;case"P":for(var m=parseInt(g[1]),n=0;m>n;n++){var r=new Prism;tools.push(r)}}}blocks=blocks.concat(predefinedBlocks),blocks=blocks.concat(tools),Util.log("level parsed"),levelID=a,gameState=GameState.IS_PLAYING,initToolBox(),options.showHints&&showHelpMessage(),startTimer(),sounds.laser.play()}},b.overrideMimeType("text/plain"),b.open("GET","levels/level"+a+".txt",!0),b.send()}var translations={START_GAME:"START GAME",OPTIONS:"OPTIONS",CREDITS:"CREDITS",LEGEND:"LEGEND",DEBUG:"debug",SHOWFPS:"Show FPS",MOUSEDEBUG:"Mouse Debug",WIN:"YOU HAVE WON! CLICK TO CONTINUE!",LOCKWARN:"CAN I HAVE YOUR MOUSE?",MIRROR:"Mirror",PRISM:"Prism",PORTALINPUT:"Portal-Input",PORTALOUTPUT:"Portal-Output",EMITTER:"Emitter",RECEIVER:"Receiver",ACTIVATOR:"Activator",MIRROR_DESCRIPTION:"Redirects a laser beam",PRISM_DESCRIPTION:"Mixes 2 different laser beams to one color",PORTALINPUT_DESCRIPTION:"Receives a laser beam and redirects it to the Portal Outputs of the same color",PORTALOUTPUT_DESCRIPTION:"Outputs a laser coming from a Portal Input of the same color",EMITTER_DESCRIPTION:"Emits a laser beam",RECEIVER_DESCRIPTION:"Has to be activated by a laser in order to complete the level",AVCTIVATOR_DESCRIPTION:"Has to be activated by a laser",FULLSCREEN:"Fullscreen",AUTHOR:"Author",ON:"On",OFF:"Off",TIME:"Level Completed in ",RESETLEVEL:"Reset level",HELPBUTTON:"Help",BACKTOMENU:"Back to menu",SHOWHINTS:"Show hints",AUTHOR:"Author"};setLanguage(navigator.language.substring(0,2)),Array.prototype.move=function(a,b){if(b>=this.length)for(var c=b-this.length;c--+1;)this.push(void 0);return this.splice(b,0,this.splice(a,1)[0]),this},Array.prototype.lastOf=function(a){for(var b=-1,c=0;c<a.length;c++)Util.log(this.indexOf(a[c])),b<this.indexOf(a[c])&&(b=this.indexOf(a[c]));return b};var Cell=function(){this.tile=void 0,this.block=void 0,this.lasers=[new Laser,new Laser]},Button=function(a,b){this.title=a,this.action=b},GameState={IN_MENU:0,IS_PLAYING:1,HAS_WON:2,IN_OPTIONS:3,IN_CREDITS:4,IN_LEGEND:5},Util=function(){};if(Util.log=function(a){1==options.debug&&console.log(a)},Util.getDateString=function(a){var b=new Date(null);return b.setSeconds(a),b.toISOString().substr(14,5)},options={debug:!1,showFPS:!0,mouseDebug:!1,fullscreen:!0,showHints:!0},null!=localStorage.getItem("options")){Util.log("Loading options from localStorage");var loadedOptions=JSON.parse(localStorage.getItem("options"));for(var key in options)void 0!=loadedOptions[key]&&(options[key]=loadedOptions[key])}var Alert=function(){this.message="",this.title="",this.subtext="",this.buttons=[]},sounds=[],soundNames=[],SoundEffects=function(){};SoundEffects.stopLaserSoundEffect=function(){null!=laserOSC&&(laserOSC.stop(),laserOSC=null)},SoundEffects.playSoundEffect=function(a){var b=window.ac.createOscillator();b.type="sawtooth",b.frequency.value=440*Math.pow(1.0594630943592953,a-49),b.connect(window.ac.destination);var c=ac.currentTime;b.start(c),b.stop(c+.1)},Emitter.prototype.toString=function(){return"Emitter"},Receiver.prototype.toString=function(){return"Receiver"},Activator.prototype.toString=function(){return"Activator"},Mirror.prototype.toString=function(){return"Mirror"},PortalInput.prototype.toString=function(){return"PortalInput"},PortalOutput.prototype.toString=function(){return"PortalOutput"},Prism.prototype.toString=function(){return"Prism"};var Colors={BACKGROUND_COLOR:"#394046",MENU_HOVER:"#fda900",TEXT_COLOR:"#ffffff",ALERT_HOVER:"#373d43",ALERT_BACKGROUND:"#515b63",ALERT_INNER_BORDER:"#2f352e",ALERT_OUTER_BORDER:"#252a25",ALERT_BUTTON_BACKGORUND:"#434b52",CREDITS_LINK:"#365ec4",CREDITS_HOVER:"#80a0fe",TOOLTIPS_BACKGROUND:"",TOOLTIPS_COLOR:""};Drawing.drawBoard=function(){for(var a=0;a<map.length;a++)for(var b=0;b<map[a].length;b++)Drawing.drawSprite("map",map[a][b].tile,a,b)},Drawing.drawSprite=function(a,b,c,d){a=a.toLowerCase(),sprites[a]&&ctx.drawImage(sprites[a],b*spriteSize,0,spriteSize,spriteSize,c*spriteSize,d*spriteSize,64,64),options.debug&&"map"!=a&&(ctx.font="10px Arial",ctx.fillStyle="red",ctx.fillText(a+" ["+b+"]",spriteSize*c+5,spriteSize*d+10),ctx.font="20px Arial",ctx.fillText(b,spriteSize*c+5,spriteSize*d+20),ctx.fillText(b*spriteSize,spriteSize*c+5,spriteSize*d+40))},Drawing.drawCursor=function(){ctx.drawImage(sprites.mouse,fullMouseX,fullMouseY)},Drawing.drawMouse=function(){-1!=selectedTool&&Drawing.drawTool(tools[selectedTool]),Mouse.isInToolBox()||Mouse.isInActionButtonArea()?ctx.fillStyle="rgba(0, 0,255,0.2)":0>selectedTool?ctx.fillStyle="rgba(255,255,255,0.1)":blockExistsAt(mouseX,mouseY)?ctx.fillStyle="rgba(255,0,0,0.3)":ctx.fillStyle="rgba(0,255,0,0.3)",ctx.fillRect(mouseX*spriteSize,mouseY*spriteSize,spriteSize,spriteSize)},Drawing.drawToolTip=function(a,b,c,d,e){var f="rgba(81, 91, 99, 0.8)",g="white",h=5;ctx.font="14px Courier New";var i=ctx.measureText(c).width+2*h,j=14+2*h;"center"==d?a-=i/2:"right"==d&&(a-=i),"center"==e?b-=j/2:"bottom"==e&&(b-=j),ctx.fillStyle=f,ctx.fillRect(a,b,i,j),ctx.textBaseline="top",ctx.fillStyle=g,ctx.fillText(c,a+h,b+h),ctx.textBaseline="alphabetic"},Drawing.drawToolTipForToolBoxTool=function(){Mouse.isInToolBox()&&Drawing.drawToolTip(mouseX*spriteSize-5,mouseY*spriteSize+spriteSize/2,translations[toolsByType[mouseY-1].toUpperCase()],"right","center")},Drawing.drawToolTipForActionButton=function(){Mouse.isInActionButtonArea()&&Drawing.drawToolTip(mouseX*spriteSize-5,mouseY*spriteSize+spriteSize/2,translations[actionButtons[mouseY-(height-4)].title.toUpperCase()],"right","center")},Drawing.drawPredefinedBlocks=function(){for(var a=0;a<predefinedBlocks.length;a++){var b=predefinedBlocks[a],c=b.toString();c=c.toLowerCase();var d=b.isOn?4:0,e=d;b.hasOwnProperty("rotation")&&(Util.log("rotation is "+b.rotation),e=b.rotation+d),"activator"==c&&(d=b.isOn?1:0,e=d),"receiver"==c&&(ctx.fillStyle=b.color,ctx.fillRect(b.x*spriteSize,b.y*spriteSize,spriteSize,spriteSize)),Util.log("index is "+e),Drawing.drawSprite(c,e-d,b.x,b.y),Drawing.fillAlphaOfBlock(b),Drawing.drawSprite(c,e,b.x,b.y)}},Drawing.drawTools=function(){for(var a=0;a<tools.length;a++)Drawing.drawTool(tools[a])},Drawing.drawTool=function(a){if("object"==typeof a){var b=a.toString(),c=0,d=0;switch(b){case"Prism":c=a.inputs[0].isOn||a.inputs[1].isOn?4:0,d=c,a.hasOwnProperty("rotation")&&(Util.log("rotation is "+a.rotation),d=a.rotation+c);break;default:c=a.isOn?4:0,d=c,a.hasOwnProperty("rotation")&&(Util.log("rotation is "+a.rotation),d=a.rotation+c)}if(Util.log("index is "+d),Drawing.drawSprite(b,d-c,a.x,a.y),"PortalInput"==b||"PortalOutput"==b){var e=a.x,f=a.y,g=e*spriteSize,h=e*spriteSize+spriteSize/2,i=f*spriteSize,j=f*spriteSize+spriteSize/2;switch(ctx.fillStyle=a.color,a.rotation){case 0:ctx.fillRect(g,j,spriteSize,spriteSize/2);break;case 1:ctx.fillRect(g,i,spriteSize/2,spriteSize);break;case 2:ctx.fillRect(g,i,spriteSize,spriteSize/2);break;case 3:ctx.fillRect(h,i,spriteSize/2,spriteSize)}}Drawing.fillAlphaOfBlock(a),Drawing.drawSprite(b,d,a.x,a.y)}},Drawing.drawLaserBeam=function(){for(var a=0;a<blocks.length;a++)if("Emitter"==blocks[a].toString()){var b=predefinedBlocks[a];Util.log("drawing laser beam from"+b.toString()),Drawing.drawLaserBeamFromObject(b)}else if("PortalOutput"==blocks[a].toString()&&blocks[a].isPlaced){void 0!=portalInputs[blocks[a].color]&&portalInputs[blocks[a].color].input.isOn&&(Drawing.drawLaserBeamFromPosition(blocks[a].x,blocks[a].y,blocks[a].rotation,portalInputs[blocks[a].color].input.color),blocks[a].isOn=!0)}},Drawing.fillAlphaOfBlocks=function(){for(var a=0;a<blocks.length;a++)fillAlphaOfTool(blocks[a])},Drawing.fillAlphaOfBlock=function(a){if("object"==typeof a&&a.isOn&&a.isPlaced){ctx.lineWidth=2;var b=a.toString(),c=a.rotation,d=a.x,e=a.y,f=d*spriteSize,g=d*spriteSize+spriteSize/2,h=f+spriteSize,i=e*spriteSize,j=e*spriteSize+spriteSize/2,k=i+spriteSize;"Emitter"==b?0==c||2==c?(ctx.beginPath(),ctx.strokeStyle=a.color,ctx.moveTo(g,i),ctx.lineTo(g,k),ctx.stroke(),ctx.closePath()):(ctx.beginPath(),ctx.strokeStyle=a.color,ctx.moveTo(f,j),ctx.lineTo(h,j),ctx.stroke(),ctx.closePath()):"Receiver"==b?(ctx.fillStyle=a.color,ctx.fillRect(f+18,i+18,30,30),ctx.beginPath(),ctx.strokeStyle=a.color,0==c||2==c?(ctx.moveTo(g,i),ctx.lineTo(g,k)):(ctx.moveTo(f,j),ctx.lineTo(h,j)),ctx.stroke(),ctx.closePath()):"Activator"==b?(ctx.fillStyle=a.color,ctx.fillRect(f,i,spriteSize/2-1,spriteSize/2-1),ctx.fillRect(g+1,i,spriteSize/2-1,spriteSize/2-1),ctx.fillRect(f,j+1,spriteSize/2-1,spriteSize/2-1),ctx.fillRect(g+1,j+1,spriteSize/2-1,spriteSize/2-1)):"Mirror"==b?0==c||2==c?(a.inputs[0].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[0].color,ctx.moveTo(g,i),ctx.lineTo(g,j-1),ctx.moveTo(g+1,j),ctx.lineTo(h,j),ctx.stroke(),ctx.closePath()),a.inputs[1].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[1].color,ctx.moveTo(g,k),ctx.lineTo(g,j),ctx.lineTo(f,j),ctx.stroke(),ctx.closePath())):(a.inputs[0].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[0].color,ctx.moveTo(g,i),ctx.lineTo(g,j-1),ctx.moveTo(g-1,j),ctx.lineTo(f,j),ctx.stroke(),ctx.closePath()),a.inputs[1].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[1].color,ctx.moveTo(g,k),ctx.lineTo(g,j),ctx.lineTo(h,j),ctx.stroke(),ctx.closePath())):"Prism"==b?0==c?(a.inputs[0].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[0].color,ctx.moveTo(f,j),ctx.lineTo(g,j),ctx.stroke(),ctx.closePath()),a.inputs[1].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[1].color,ctx.moveTo(h,j),ctx.lineTo(g,j),ctx.stroke(),ctx.closePath()),ctx.beginPath(),ctx.strokeStyle=mixColors(a.inputs[0].color,a.inputs[1].color),ctx.moveTo(g,j),ctx.lineTo(g,i),ctx.stroke(),ctx.closePath()):1==c?(a.inputs[0].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[0].color,ctx.moveTo(g,i),ctx.lineTo(g,j),ctx.stroke(),ctx.closePath()),a.inputs[1].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[1].color,ctx.moveTo(g,j),ctx.lineTo(g,k),ctx.stroke(),ctx.closePath()),ctx.beginPath(),ctx.strokeStyle=mixColors(a.inputs[0].color,a.inputs[1].color),ctx.moveTo(g,j),ctx.lineTo(h,j),ctx.stroke(),ctx.closePath()):2==c?(a.inputs[0].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[0].color,ctx.moveTo(h,j),ctx.lineTo(g,j),ctx.stroke(),ctx.closePath()),a.inputs[1].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[1].color,ctx.moveTo(g,j),ctx.lineTo(f,j),ctx.stroke(),ctx.closePath()),ctx.beginPath(),ctx.strokeStyle=mixColors(a.inputs[0].color,a.inputs[1].color),ctx.moveTo(g,j),ctx.lineTo(g,k),ctx.stroke(),ctx.closePath()):3==c&&(a.inputs[0].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[0].color,ctx.moveTo(g,j),ctx.lineTo(g,k),ctx.stroke(),ctx.closePath()),a.inputs[1].isOn&&(ctx.beginPath(),ctx.strokeStyle=a.inputs[1].color,ctx.moveTo(g,i),ctx.lineTo(g,j),ctx.stroke(),ctx.closePath()),ctx.beginPath(),ctx.strokeStyle=mixColors(a.inputs[0].color,a.inputs[1].color),ctx.moveTo(f,j),ctx.lineTo(g,j),ctx.stroke(),ctx.closePath()):("PortalInput"==b||"PortalOutput"==b)&&(ctx.beginPath(),"PortalInput"==b?ctx.strokeStyle=a.input.color:ctx.strokeStyle=portalInputs[a.color].input.color,0==c?(ctx.moveTo(g,i),ctx.lineTo(g,j),ctx.stroke(),ctx.closePath()):1==c?(ctx.moveTo(g,j),ctx.lineTo(h,j),ctx.stroke(),ctx.closePath()):2==c?(ctx.moveTo(g,j),ctx.lineTo(g,k),ctx.stroke(),ctx.closePath()):3==c&&(ctx.moveTo(f,j),ctx.lineTo(g,j),ctx.stroke(),ctx.closePath()))}},Drawing.drawLaserBeamInCell=function(a,b,c,d){var e=!0,f=0,g=map[c][d].block;if(void 0==g&&-1!=selectedTool&&tools[selectedTool].x===c&&tools[selectedTool].y===d&&(g=tools[selectedTool]),void 0!=g&&g.isPlaced){var h=g.toString();if(1==g.isPredefined)"Activator"==h?(g.color=a,g.isOn=!0):"Receiver"==h?(e=!1,g.input.isOn=!0,g.input.color=a):e=!1;else if(e=!1,"Mirror"==g.toString()){for(var f=0;f<g.interfaces.length;f++);switch(g.rotation){case 0:case 2:0==b||1==b?(g.inputs[0].isOn=!0,g.inputs[0].color=a):(2==b||3==b)&&(g.inputs[1].isOn=!0,g.inputs[1].color=a),Drawing.drawLaserBeamFromPosition(c,d,(5-b)%4,a);break;case 1:case 3:0==b||3==b?(g.inputs[0].isOn=!0,g.inputs[0].color=a):(1==b||2==b)&&(g.inputs[1].isOn=!0,g.inputs[1].color=a),Drawing.drawLaserBeamFromPosition(c,d,3-b,a)}g.isOn=!0}else if("Prism"==g.toString()){var i=!1;switch(g.rotation){case 0:case 2:b==3-g.rotation&&(g.inputs[0].isOn=!0,g.inputs[0].color=a,i=!0),b==1+g.rotation&&(g.inputs[1].isOn=!0,g.inputs[1].color=a,i=!0);break;case 1:case 3:b==(3+g.rotation)%4&&(g.inputs[0].isOn=!0,g.inputs[0].color=a,i=!0),b==3-g.rotation&&(g.inputs[1].isOn=!0,g.inputs[1].color=a,i=!0)}i&&(g.inputs[0].isOn&&!g.inputs[1].isOn?Drawing.drawLaserBeamFromPosition(c,d,g.rotation,g.inputs[0].color):!g.inputs[0].isOn&&g.inputs[1].isOn?Drawing.drawLaserBeamFromPosition(c,d,g.rotation,g.inputs[1].color):g.inputs[0].isOn&&g.inputs[1].isOn&&Drawing.drawLaserBeamFromPosition(c,d,g.rotation,mixColors(g.inputs[0].color,g.inputs[1].color)),g.isOn=!0)}else"PortalInput"==g.toString()&&b==g.rotation&&(g.isOn=!0,g.input.isOn=!0,g.input.color=a)}if(Util.log("Drawing laser beam in cell "+c+", "+d+"with rotation of "+90*b+" degrees"),e)switch(map[c][d].tile){case Tiles.CLEAR:switch(ctx.strokeStyle=a,ctx.lineWidth=2,ctx.beginPath(),b){case 0:case 2:ctx.moveTo(c*spriteSize+spriteSize/2,d*spriteSize+spriteSize),ctx.lineTo(c*spriteSize+spriteSize/2,d*spriteSize);break;case 1:case 3:ctx.moveTo(c*spriteSize,d*spriteSize+spriteSize/2),ctx.lineTo(c*spriteSize+spriteSize,d*spriteSize+spriteSize/2)}ctx.stroke(),ctx.closePath(),e=!0;break;default:e=!1}return e},Drawing.drawToolbar=function(){for(var a=0;height>a;a++)Drawing.drawSprite("inventory",1,15,a)},Drawing.drawToolbox=function(){Util.log("drawing toolbox");for(var a=0;a<toolsByType.length;a++){Util.log("Drawing "+toolsByType[a].toString()+" at "+(a+1)),ctx.fillStyle="white",ctx.font="14px Courier New";for(var b=0,c=0;c<toolsByType[toolsByType[a]].length;c++)0==toolsByType[toolsByType[a]][c].isPlaced&&b++;Drawing.drawSprite("inventory",0,15,a+1),b>0&&ctx.fillText(b,15.75*spriteSize,spriteSize*(a+2)-.15*spriteSize)}},Drawing.drawLaserBeamFromObject=function(a){Util.log("drawing laser beam from "+a.toString());var b=a.color;switch(a.rotation){case 0:var c=a.y;for(beaming=!0,"Mirror"!=a.toString()&&Drawing.drawLaserBeamInCell(b,(a.rotation+2)%4,a.x,c),c--;c>0&&beaming;)beaming=Drawing.drawLaserBeamInCell(b,(a.rotation+2)%4,a.x,c),c--;break;case 1:var c=a.x;for(beaming=!0,"Mirror"!=a.toString()&&Drawing.drawLaserBeamInCell(b,(a.rotation+2)%4,c,a.y),c++;width>c&&beaming;)beaming=Drawing.drawLaserBeamInCell(b,(a.rotation+2)%4,c,a.y),c++,Util.log("drawing laser at "+c+" "+a.y+" beaming is "+beaming);break;case 2:var c=a.y;for(beaming=!0,"Mirror"!=a.toString()&&Drawing.drawLaserBeamInCell(a.rotation,(a.rotation+2)%4,a.x,c),c++;height>c&&beaming;)beaming=Drawing.drawLaserBeamInCell(b,(a.rotation+2)%4,a.x,c),c++;break;case 3:var c=a.x;for(beaming=!0,"Mirror"!=a.toString()&&Drawing.drawLaserBeamInCell(a.rotation,(a.rotation+2)%4,c,a.y),c--;c>0&&beaming;)beaming=Drawing.drawLaserBeamInCell(b,(a.rotation+2)%4,c,a.y),c--}},Drawing.drawLaserBeamFromPosition=function(a,b,c,d){switch(c){case 0:var e=b;for(beaming=!0,e--;e>0&&beaming;)beaming=Drawing.drawLaserBeamInCell(d,(c+2)%4,a,e),e--;break;case 1:var e=a;for(beaming=!0,e++;width>e&&beaming;)beaming=Drawing.drawLaserBeamInCell(d,(c+2)%4,e,b),e++,Util.log("drawing laser at "+e+" "+b+" beaming is "+beaming);break;case 2:var e=b;for(beaming=!0,e++;height>e&&beaming;)beaming=Drawing.drawLaserBeamInCell(d,(c+2)%4,a,e),e++;break;case 3:var e=a;for(beaming=!0,e--;e>0&&beaming;)beaming=Drawing.drawLaserBeamInCell(d,(c+2)%4,e,b),e--}},Drawing.fillTextRotated=function(a,b,c,d){var e=d*Math.PI/180;ctx.rotate(-e),ctx.fillText(a,b,c),ctx.rotate(e)},Drawing.fillTextCentered=function(a,b){var d=(c.width-ctx.measureText(a).width)/2;ctx.fillText(a,d,b)},Drawing.drawTitle=function(a){var b=ctx.font;ctx.font="48px TS4F",ctx.fillStyle="white";var d=(c.width-ctx.measureText(a).width)/2,e=3*Math.PI/180;ctx.rotate(-e),ctx.fillText(a,d,120),ctx.rotate(e),ctx.font=b},Drawing.drawMenuScreen=function(){ctx.fillStyle=Colors.BACKGROUND_COLOR,ctx.fillRect(0,0,c.width,c.height),ctx.drawImage(sprites.logo,(c.width-sprites.logo.width)/2,200),ctx.fillStyle="white",ctx.font="36px TS4F";for(var a=50,b=0,d=0;d<menu.length;d++){var e=1.1*ctx.measureText(translations[menu[d].title]).width;b=b+e+a}for(var f=(c.width-b)/2,d=0;d<menu.length;d++)ctx.fillStyle="white",d==selectedMenuItem&&(ctx.fillStyle=Colors.MENU_HOVER),Drawing.fillTextRotated(translations[menu[d].title],f,.68*c.height+3*d,5),ctx.fillStyle=Colors.TEXT_COLOR,f=f+1.1*ctx.measureText(translations[menu[d].title]).width+a},Drawing.drawPointerLockWarning=function(){ctx.fillStyle=Colors.BACKGROUND_COLOR,ctx.fillRect(0,0,c.width,c.height),ctx.drawImage(sprites.logo,(c.width-sprites.logo.width)/2,200),ctx.fillStyle="white",ctx.font="48px TS4F",Drawing.fillTextCentered(translations.LOCKWARN,.65*c.height)},Drawing.drawWinScreen=function(){ctx.fillStyle=Colors.BACKGROUND_COLOR,ctx.fillRect(0,0,c.width,c.height),ctx.fillStyle=Colors.TEXT_COLOR,ctx.font="48px TS4F",ctx.drawImage(sprites.wonPotato,(c.width-sprites.wonPotato.width)/2,200),Drawing.fillTextCentered(translations.WIN,.65*c.height),ctx.font="36px TS4F",Drawing.fillTextCentered(translations.TIMER+Util.getDateString(timerElapsed),.8*c.height)},Drawing.drawBoolean=function(a,b,c){ctx.fillStyle="white";var d=translations.OFF;c&&(d=translations.ON),ctx.fillText(d,a,b)},Drawing.drawSlider=function(a,b,c,d,e){Util.log("drawing line from "+a+" to "+(a+c));var f=8;ctx.strokeStyle="white",ctx.lineWidth=2.5,ctx.beginPath(),ctx.moveTo(a,b),ctx.lineTo(a+c,b),ctx.stroke(),ctx.fillStyle="white";var g=a+e*c;ctx.fillRect(g,b-d/2,f,d)},Drawing.drawBackButton=function(){var a=ctx.font;ctx.font="72px TS4F",backButtonHover&&(ctx.fillStyle=Colors.MENU_HOVER),ctx.fillText("<",100,100),ctx.font=a,ctx.fillStyle="width"},Drawing.drawOptions=function(){ctx.fillStyle=Colors.BACKGROUND_COLOR,ctx.fillRect(0,0,c.width,c.height);var a=0;ctx.fillStyle=Colors.TEXT_COLOR,ctx.font="36px TS4F",Drawing.drawTitle(translations.OPTIONS),Drawing.drawBackButton();for(var b in options){switch(ctx.fillStyle=Colors.TEXT_COLOR,selectedMenuItem==a&&(ctx.fillStyle=Colors.MENU_HOVER),ctx.fillText(translations[b.toUpperCase()],.2*c.width,.3*c.height+45*a),typeof options[b]){case"string":break;case"boolean":Drawing.drawBoolean(c.width-.3*c.width,.3*c.height+45*a,options[b]);break;case"number":Drawing.drawSlider(c.width-.3*c.width,.3*c.height+45*a,100,20,options[b])}a++}},Drawing.drawActionButtons=function(){for(var a=0;a<actionButtons.length;a++)Drawing.drawSprite("menu",a,15,height-4+a),Drawing.drawSprite("inventory",0,15,height-4+a)},Drawing.drawCredits=function(){ctx.fillStyle=Colors.BACKGROUND_COLOR,ctx.fillRect(0,0,c.width,c.height),Drawing.drawTitle(translations.CREDITS),Drawing.drawBackButton();for(var a=0;a<credits.length;a++)ctx.font="40px TS4F",ctx.fillStyle=Colors.TEXT_COLOR,credits[a].pos[0]=.2*c.width,credits[a].pos[1]=.3*c.height+80*a,credits[a].size[0]=ctx.measureText(credits[a].name).width,credits[a].size[1]=30,ctx.fillText(credits[a].name,credits[a].pos[0],credits[a].pos[1]),ctx.font="24px TS4F",ctx.fillStyle=Colors.CREDITS_LINK,a==selectedMenuItem&&(ctx.fillStyle=Colors.CREDITS_HOVER),ctx.fillText(credits[a].link,credits[a].pos[0],credits[a].pos[1]+credits[a].size[1])},Drawing.drawAlert=function(){ctx.fillStyle=Colors.ALERT_BACKGROUND,ctx.fillRect(.15*c.width,.2*c.height,.7*c.width,.6*c.height),ctx.strokeStyle=Colors.ALERT_INNER_BORDER,ctx.beginPath(),ctx.moveTo(.15*c.width,.2*c.height-1),ctx.lineTo(.85*c.width+1,.2*c.height-1),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.moveTo(.15*c.width,.8*c.height),ctx.lineTo(.85*c.width,.8*c.height),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.moveTo(.15*c.width-1,.2*c.height),ctx.lineTo(.15*c.width-1,.8*c.height+1),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.moveTo(.85*c.width+1,.2*c.height),ctx.lineTo(.85*c.width+1,.8*c.height+2),ctx.stroke(),ctx.closePath(),ctx.strokeStyle=Colors.ALERT_OUTER_BORDER,ctx.beginPath(),ctx.moveTo(.15*c.width+2,.2*c.height-2),ctx.lineTo(.85*c.width+2,.2*c.height-2),ctx.stroke(),ctx.closePath(),ctx.beginPath(),ctx.moveTo(.15*c.width+2,.8*c.height+2),ctx.lineTo(.85*c.width,.8*c.height+2),ctx.stroke(),ctx.closePath(),ctx.fillStyle="white",ctx.font="48px TS4F";var a=.7*c.width;ctx.fillText(currentAlert.title,(c.width-ctx.measureText(currentAlert.title).width)/2,.2*c.height+48),ctx.font="28px TS4F";for(var b=currentAlert.message.split(" "),d=.8*a,e=[],f="",g=0;g<b.length;g++)ctx.measureText(f+b[g]+" ").width<d?f+=b[g]+" ":(e.push(f),f=b[g]+" ");e.push(f),e[e.length-1]=e[e.length-1].substring(0,e[e.length-1].length-1);for(var h=.2*c.height+96,g=0;g<e.length;g++)ctx.fillText(e[g],(c.width-d)/2,h+36*g);ctx.textBaseline="bottom",ctx.fillText(currentAlert.subtext,.85*c.width-ctx.measureText(currentAlert.subtext).width-10,.7*c.height-10),ctx.textBaseline="alphabetic";var i=.7*c.width/currentAlert.buttons.length,j=80;ctx.font="36px TS4F";for(var g=0;g<currentAlert.buttons.length;g++)ctx.fillStyle=Colors.ALERT_BUTTON_BACKGORUND,g==selectedMenuItem&&(ctx.fillStyle=Colors.ALERT_HOVER),ctx.fillRect(.15*c.width+g*i,.8*c.height-j,i,j),ctx.fillStyle=Colors.TEXT_COLOR,Util.log("drawing text at x "+(.15*c.width+g*i+10)+" y "+(.8*c.height-10)),ctx.fillText(currentAlert.buttons[g].title,.15*c.width+g*i+(i-ctx.measureText(currentAlert.buttons[g].title).width)/2,.8*c.height-(j/2-18))},Drawing.drawFPS=function(){lastCalledTime||(lastCalledTime=Date.now(),fps=0),delta=((new Date).getTime()-lastCalledTime)/1e3,lastCalledTime=Date.now(),fps=parseInt(1/delta),(new Date).getTime()>=lastFpsDraw+1e3&&(lastShownFps=fps,lastFpsDraw=Date.now()),1==options.showFPS&&(ctx.fillStyle=gameState==GameState.IS_PLAYING?"#394046":"white",ctx.font="bold 36px Courier New",ctx.fillText(lastShownFps,c.width-ctx.measureText(fps).width-5,32))},Drawing.drawLegend=function(){ctx.fillStyle=Colors.BACKGROUND_COLOR,ctx.fillRect(0,0,c.width,c.height),Drawing.drawTitle(translations.LEGEND),Drawing.drawBackButton();for(var a=0;a<allTypes.length;a++){
Drawing.drawSprite(allTypes[a].toString(),0,1,a+3),ctx.fillStyle=Colors.TEXT_COLOR,ctx.font="36px TS4F",ctx.fillText(translations[allTypes[a].toString().toUpperCase()],140,64*(a+4)-18),ctx.font="24px TS4F";var b=allTypes[a].toString().toUpperCase()+"_DESCRIPTION";ctx.fillText(translations[b],140,64*(a+4)+7)}};var Keyboard=function(){document.addEventListener("keydown",Keyboard.keydown),document.addEventListener("keypress",Keyboard.keypress),document.addEventListener("keyup",Keyboard.keyup)};Keyboard.keydown=function(a){if(Util.log("Key pressed: "),Util.log(a),!Keyboard.shiftKeyPressed&&a.shiftKey&&(Keyboard.shiftKeyPressed=!0),a.ctrlKey&&a.altKey)document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock();else switch(gameState){case GameState.IS_PLAYING:82==a.keyCode?a.shiftKey?-1!=selectedTool?rotateTool(tools[selectedTool],-1):rotateTool(map[mouseX][mouseY].block,-1):82==a.keyCode&&rotateTool(-1!=selectedTool?tools[selectedTool]:map[mouseX][mouseY].block):49==a.keyCode?Mouse.selectTool(getToolFromToolbox(0)):50==a.keyCode?Mouse.selectTool(getToolFromToolbox(1)):51==a.keyCode?Mouse.selectTool(getToolFromToolbox(2)):52==a.keyCode?Mouse.selectTool(getToolFromToolbox(3)):53==a.keyCode?Mouse.selectTool(getToolFromToolbox(4)):54==a.keyCode?Mouse.selectTool(getToolFromToolbox(5)):55==a.keyCode?Mouse.selectTool(getToolFromToolbox(6)):56==a.keyCode?Mouse.selectTool(getToolFromToolbox(7)):57==a.keyCode?Mouse.selectTool(getToolFromToolbox(8)):48==a.keyCode&&Mouse.selectTool(getToolFromToolbox(9))}},Keyboard.keyup=function(a){Keyboard.shiftKeyPressed&&!a.shiftKey&&(Keyboard.shiftKeyPressed=!1)};var Mouse=function(){c.addEventListener("mousedown",Mouse.click),c.addEventListener("mousemove",Mouse.move),c.addEventListener("wheel",Mouse.wheel)};Mouse.click=function(a){if(document.pointerLockElement===c||document.mozPointerLockElement===c||document.webkitPointerLockElement===c)switch(gameState){case GameState.IS_PLAYING:switch(a.button){case 0:if(currentAlert)selectedMenuItem=Mouse.getButtonIDForPosition(fullMouseX,fullMouseY),Util.log("selected index "+selectedMenuItem),currentAlert.buttons[selectedMenuItem].action();else if(-1==selectedTool)if(mouseIsInToolBox()&&(Util.log("block clicked, selected tool is  "+toolsByType[mouseY-1]),Mouse.selectTool(getToolFromToolbox(mouseY-1))),15==mouseX&&11>mouseY&&mouseY>10-actionButtons.length){var b=mouseY-(height-actionButtons.length)+1;Util.log("clicked button "+b),actionButtons[b].action()}else void 0!=map[mouseX][mouseY].block&&(Keyboard.shiftKeyPressed?(Mouse.selectTool(map[mouseX][mouseY].block),unplaceBlock(map[mouseX][mouseY].block,!1)):rotateTool(map[mouseX][mouseY].block));else{var d=blockExistsAt(mouseX,mouseY,tools[selectedTool]);d||(placeBlock(tools[selectedTool]),selectedTool=-1)}break;case 2:Util.log("right click"),-1!=selectedTool?(unplaceBlock(tools[selectedTool]),selectedTool=-1):unplaceBlock(map[mouseX][mouseY].block)}break;case GameState.IN_MENU:-1!=selectedMenuItem&&menu[selectedMenuItem].action();break;case GameState.HAS_WON:loadLevel(++levelID);break;case GameState.IN_OPTIONS:backButtonHover?(checkOptions(),gameState=GameState.IN_MENU):Mouse.toggleOption();break;case GameState.IN_CREDITS:backButtonHover&&(gameState=GameState.IN_MENU),window.open(credits[selectedMenuItem].link);break;case GameState.IN_LEGEND:backButtonHover&&(checkOptions(),gameState=GameState.IN_MENU)}else lockMouse();return!1},Mouse.wheel=function(a){},Mouse.getOptionIDForPosition=function(a,b){if(fullMouseX>.2*c.width&&fullMouseX<.7*c.width){var d=parseInt((b+45-.3*c.height)/45);return d<Object.keys(options).length?d:-1}},Mouse.getCreditIDForPosition=function(a,b){for(var c=0;c<credits.length;c++)if(credits[c].pos[0]<=a&&credits[c].pos[1]<=b&&a<=credits[c].pos[0]+credits[c].size[0]&&b<=credits[c].pos[1]+credits[c].size[1])return c},Mouse.getMenuItemIDForPosition=function(a,b){if(b>.6*c.height&&b<.7*c.height){for(var d=50,e=0,f=0;f<menu.length;f++){var g=1.1*ctx.measureText(menu[f].title).width;e=e+g+d}for(var h=(c.width-e)/2,f=0;f<menu.length;f++){if(a>h&&fullMouseX<h+1.1*ctx.measureText(menu[f].title).width+d)return f;h=h+1.1*ctx.measureText(menu[f].title).width+d}}return-1},Mouse.getButtonIDForPosition=function(a,b){return a>.15*c.width&&a<=.85*c.width&&b>.8*c.height-80&&b<.8*c.height?parseInt((a-.15*c.width)/(.7*c.width/currentAlert.buttons.length)):void 0},Mouse.toggleOption=function(){var a=0;for(var b in options)a==selectedMenuItem&&"boolean"==typeof options[b]&&(options[b]=!options[b],Util.log("toggled "+b)),a++;saveOptions()},Mouse.setBackButton=function(){backButtonHover=fullMouseX>=80&&150>=fullMouseX&&fullMouseY>=50&&150>=fullMouseY?!0:!1},Mouse.move=function(a){if(document.pointerLockElement===c||document.mozPointerLockElement===c||document.webkitPointerLockElement===c){var b=a.movementX||a.mozMovementX||a.webkitMovementX||0,d=a.movementY||a.mozMovementY||a.webkitMovementY||0;fullMouseX+=b,fullMouseY+=d,0>fullMouseX&&(fullMouseX=0),fullMouseX>c.width-16&&(fullMouseX=c.width-16),0>fullMouseY&&(fullMouseY=0),fullMouseY>c.height-16&&(fullMouseY=c.height-16);var e=Math.floor(fullMouseX/spriteSize),f=Math.floor(fullMouseY/spriteSize);switch(mouseX=e,mouseY=f,gameState){case GameState.IN_MENU:selectedMenuItem=Mouse.getMenuItemIDForPosition(fullMouseX,fullMouseY);break;case GameState.IS_PLAYING:currentAlert?(selectedMenuItem=Mouse.getButtonIDForPosition(fullMouseX,fullMouseY),console.log("selected index "+selectedMenuItem)):selectedTool>-1&&(tools[selectedTool].isPlaced=!blockExistsAt(mouseX,mouseY,tools[selectedTool]),tools[selectedTool].x=mouseX,tools[selectedTool].y=mouseY);break;case GameState.IN_OPTIONS:Mouse.setBackButton(),selectedMenuItem=Mouse.getOptionIDForPosition(fullMouseX,fullMouseY),Util.log("selected index "+selectedMenuItem);break;case GameState.IN_CREDITS:Mouse.setBackButton(),selectedMenuItem=Mouse.getCreditIDForPosition(fullMouseX,fullMouseY),Util.log("selectedMenuItem "+selectedMenuItem);break;case GameState.IN_LEGEND:Mouse.setBackButton()}}},Mouse.selectTool=function(a){-1==selectedTool&&("object"==typeof a?selectedTool=tools.indexOf(a):"number"==typeof a&&a>=-1&&a<tools.length&&(selectedTool=a),-1!=selectedTool&&(tools[selectedTool].isPlaced=!blockExistsAt(mouseX,mouseY,tools[selectedTool]),tools[selectedTool].x=mouseX,tools[selectedTool].y=mouseY))},Mouse.isInToolBox=function(){return 15==mouseX&&mouseY>0&&mouseY<=toolsByType.length},Mouse.isInActionButtonArea=function(){return 15==mouseX&&11>mouseY&&mouseY>10-actionButtons.length};var ctx,c,sprites=[],spriteSize=64,width=16,height=12,levelID,level,map=[],tools=[],blocks=[],predefinedBlocks=[],portalInputs=[],mouseX=0,mouseY=0,selectedTool=-1,fullMouseX=0,fullMouseY=0,selectedMenuItem=-1,gameState,backButtonHover=!1,currentAlert,startTime=0,timerRunning=!1,timerElapsed=0,lastCalledTime,fps,lastShownFps=0,lastFpsDraw=Date.now(),menu=[{title:"START_GAME",action:startGame},{title:"OPTIONS",action:showOptions},{title:"LEGEND",action:showLegend},{title:"CREDITS",action:showCredits}],actionButtons=[new Button("resetLevel",resetLevel),new Button("helpButton",showHelpMessage),new Button("backToMenu",backToMenu)],allTypes=[new Emitter,new Receiver,new Mirror,new Prism,new Activator,new PortalInput,new PortalOutput],credits=[{name:"Dejan Brinker",link:"https://github.com/Dede98",pos:[0,0],size:[0,0]},{name:"Timon Ringwald",link:"http://tordarus.net",pos:[0,0],size:[0,0]},{name:"Tobias Timpe",link:"http://tobias.tim.pe",pos:[0,0],size:[0,0]},{name:"Stefan Wiebe",link:"http://5tefan.net",pos:[0,0],size:[0,0]}];
//# sourceMappingURL=sourceMap.map